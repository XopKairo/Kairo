"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _reactNative = require("react-native");
var _zegoZimReactNative = require("zego-zim-react-native");
var _defines = _interopRequireDefault(require("./defines"));
var _logger = require("../utils/logger");
var _user_in_room_attributes_core = _interopRequireDefault(require("./user_in_room_attributes_core"));
var _room_properties_core = _interopRequireDefault(require("./room_properties_core"));
var _ZegoUIKitCorePlugin = _interopRequireDefault(require("../../components/internal/ZegoUIKitCorePlugin"));
var _in_room_message_core = _interopRequireDefault(require("./in_room_message_core"));
var _enum_name = require("../../utils/enum_name");
var _report = _interopRequireDefault(require("../../utils/report"));
var _ZegoSignalingPluginCore;
function _interopRequireDefault(e) { return e && e.__esModule ? e : { default: e }; }
function _defineProperty(e, r, t) { return (r = _toPropertyKey(r)) in e ? Object.defineProperty(e, r, { value: t, enumerable: !0, configurable: !0, writable: !0 }) : e[r] = t, e; }
function _toPropertyKey(t) { var i = _toPrimitive(t, "string"); return "symbol" == typeof i ? i : i + ""; }
function _toPrimitive(t, r) { if ("object" != typeof t || !t) return t; var e = t[Symbol.toPrimitive]; if (void 0 !== e) { var i = e.call(t, r || "default"); if ("object" != typeof i) return i; throw new TypeError("@@toPrimitive must return a primitive value."); } return ("string" === r ? String : Number)(t); }
class ZegoSignalingPluginCore {
  constructor() {
    _defineProperty(this, "_loginUser", {});
    _defineProperty(this, "_isLogin", false);
    _defineProperty(this, "_callIDUsers", new Map());
    // <zim call id, user id>
    _defineProperty(this, "_callIDExtendedData", new Map());
    // <zim call id, extendedData>
    _defineProperty(this, "_connectionState", _zegoZimReactNative.ZIMConnectionState.Disconnected);
    _defineProperty(this, "_onConnectionStateChangedCallbackMap", {});
    _defineProperty(this, "_onCallInvitationReceivedCallbackMap", {});
    _defineProperty(this, "_onCallInvitationCancelledCallbackMap", {});
    _defineProperty(this, "_onCallInvitationAcceptedCallbackMap", {});
    _defineProperty(this, "_onCallInvitationRejectedCallbackMap", {});
    _defineProperty(this, "_onCallInvitationTimeoutCallbackMap", {});
    _defineProperty(this, "_onCallInviteesAnsweredTimeoutCallbackMap", {});
    _defineProperty(this, "_currentInvitationID", '');
    _defineProperty(this, "_onRequireNewTokenCallbackMap", {});
    _defineProperty(this, "_onLoginSuccessCallbackMap", {});
    if (!ZegoSignalingPluginCore.shared) {
      (0, _logger.zloginfo)('[Core]ZegoSignalingPluginCore successful instantiation.');
      ZegoSignalingPluginCore.shared = this;
    }
    return ZegoSignalingPluginCore.shared;
  }
  static getInstance() {
    if (!ZegoSignalingPluginCore.shared) {
      ZegoSignalingPluginCore.shared = new ZegoSignalingPluginCore();
    }
    return ZegoSignalingPluginCore.shared;
  }
  // ------- internal events register ------
  _registerEngineCallback() {
    (0, _logger.zloginfo)('[Core]Register callback for ZIM...');
    _ZegoUIKitCorePlugin.default.getZIMPlugin().default.getInstance().on('error', (zim, errorInfo) => {
      (0, _logger.zlogerror)(`[Core]Zim error, code:${errorInfo.code}, message:${errorInfo.message}.`);
    });
    _ZegoUIKitCorePlugin.default.getZIMPlugin().default.getInstance().on('connectionStateChanged', (zim, {
      state,
      event,
      extendedData
    }) => {
      (0, _logger.zloginfo)(`[Core]Connection state changed, state:${(0, _enum_name.getZimConnectionStateName)(state)}, event:${(0, _enum_name.getZimConnectionEventName)(event)}, extended data:${extendedData}`);
      this._connectionState = state;
      this._notifyConnectionStateChanged({
        state
      });
      if (this._connectionState === _zegoZimReactNative.ZIMConnectionState.Disconnected) {
        (0, _logger.zlogwarning)('[Core]Disconnected, auto logout.');
        // this.logout();
      }
    });

    // Callback of the call invitation received by the invitee.
    _ZegoUIKitCorePlugin.default.getZIMPlugin().default.getInstance().on('callInvitationReceived', (zim, {
      callID,
      inviter,
      timeout,
      extendedData
    }) => {
      (0, _logger.zloginfo)('[Core][callInvitationReceived callback]', 'callID:', callID, 'inviter:', inviter, 'timeout:', timeout, 'extendedData:', extendedData);
      if (this._currentInvitationID == callID) {
        return;
      } else {
        this._currentInvitationID = callID;
      }
      this._callIDUsers.set(callID, inviter);
      this._callIDExtendedData.set(callID, extendedData);
      const notifyData = {
        callID,
        inviter: {
          id: inviter
        }
      };
      if (extendedData) {
        const extendedMap = JSON.parse(extendedData);
        notifyData.inviter.name = extendedMap.inviter_name;
        notifyData.type = extendedMap.type;
        notifyData.data = extendedMap.data;
        notifyData.timeout = timeout;
      }
      this._notifyCallInvitationReceived(notifyData);
      _report.default.reportEvent('invitationReceived', {
        'call_id': notifyData.callID,
        'inviter': notifyData.inviter.id,
        'app_state': _reactNative.AppState.currentState,
        'extended_data': extendedData
      });
    });
    _ZegoUIKitCorePlugin.default.getZIMPlugin().default.getInstance().on('callUserStateChanged', (zim, result) => {
      let callID = result.callID;
      let callUserList = result.callUserList;
      let callerID = this._getInviterIDByCallID(callID);
      (0, _logger.zloginfo)(`[SignalingPluginCore][callUserStateChanged callback], callID: ${callID}, callerID: ${callerID}, callUserList: ${JSON.stringify(callUserList)}`);
      callUserList.map(callUserInfo => {
        let callUserID = callUserInfo.userID;
        let callUserState = callUserInfo.state;
        let callExtendedData = callUserInfo.extendedData;
        if (callUserState === _zegoZimReactNative.ZIMCallUserState.Accepted && callUserID !== this._loginUser.userID) {
          // 1
          // as caller, state changed to Accepted as soon as after call, and wait for the other callees to change to the Accepted state
          // as callee, should ignore anyone state changed callback
          (0, _logger.zloginfo)(`[SignalingPluginCore][callUserStateChanged callback], detect ${callUserID} Accepted`);
          if (this._loginUser.userID !== callerID) {
            (0, _logger.zloginfo)(`[SignalingPluginCore][callUserStateChanged callback], ignore`);
          } else if (callUserID !== this._loginUser.userID) {
            // detect other state changed
            (0, _logger.zloginfo)(`[SignalingPluginCore][callUserStateChanged callback], notifyCallInvitationAccepted`);
            let dataParsed = callExtendedData ? JSON.parse(callExtendedData) : {};
            dataParsed.callID = callID;
            dataParsed.call_id = dataParsed.call_id ?? '';
            dataParsed.invitee = dataParsed.invitee ?? {
              userID: callUserID,
              userName: ''
            };
            const notifyData = {
              callID,
              invitee: {
                id: callUserID,
                name: ''
              },
              data: JSON.stringify(dataParsed)
            };
            this._notifyCallInvitationAccepted(notifyData);
          }
        } else if (callUserState === _zegoZimReactNative.ZIMCallUserState.Rejected) {
          // 2
          // as caller, wait for the other callees's state changed to Rejected
          // as callee, should ignore anyone state changed callback
          (0, _logger.zloginfo)(`[SignalingPluginCore][callUserStateChanged callback], detect ${callUserID} Rejected`);
          if (this._loginUser.userID !== callerID) {
            (0, _logger.zloginfo)(`[SignalingPluginCore][callUserStateChanged callback], ignore`);
          } else {
            // detect other state changed
            (0, _logger.zloginfo)(`[SignalingPluginCore][callUserStateChanged callback], notifyCallInvitationRejected`);
            let dataParsed = callExtendedData ? JSON.parse(callExtendedData) : {};
            dataParsed.callID = callID;
            dataParsed.call_id = dataParsed.call_id ?? '';
            dataParsed.invitee = dataParsed.invitee ?? {
              userID: callUserID,
              userName: ''
            };
            const notifyData = {
              callID,
              invitee: {
                id: callUserID,
                name: ''
              },
              data: JSON.stringify(dataParsed)
            };
            this._notifyCallInvitationRejected(notifyData);
          }
        } else if (callUserState === _zegoZimReactNative.ZIMCallUserState.Timeout) {
          // 6
          // as caller, wait for the other callees's state changed to the Timeout
          // as callee, should only care own state changed to Timeout
          (0, _logger.zloginfo)(`[SignalingPluginCore][callUserStateChanged callback], detect ${callUserID} Timeout`);

          // timeout 的 extendedData 为空，为方便后续使用，使用 callInvite 时的 extendedData
          let _callExtendedData = this._getExtendedDataByCallID(callID);
          if (this._loginUser.userID === callerID) {
            (0, _logger.zloginfo)(`[SignalingPluginCore][callUserStateChanged callback], notifyCallInviteesAnsweredTimeout`);
            let dataParsed = _callExtendedData ? JSON.parse(_callExtendedData) : {};
            dataParsed.call_id = dataParsed.call_id ?? '';
            dataParsed.invitees = [{
              userID: callUserID,
              userName: ''
            }];
            const notifyData = {
              callID,
              invitees: [{
                id: callUserID,
                name: ''
              }],
              data: JSON.stringify(dataParsed)
            };
            this._notifyCallInviteesAnsweredTimeout(notifyData); // for onOutgoingCallTimeout
          } else if (callUserID === this._loginUser.userID) {
            (0, _logger.zloginfo)(`[SignalingPluginCore][callUserStateChanged callback], notifyCallInvitationTimeout`);
            let dataParsed = _callExtendedData ? JSON.parse(_callExtendedData) : {};
            dataParsed.call_id = dataParsed.call_id ?? '';
            dataParsed.inviter = [{
              userID: this._getInviterIDByCallID(callID),
              userName: ''
            }];
            const notifyData = {
              callID,
              inviter: {
                id: this._getInviterIDByCallID(callID),
                name: ''
              },
              data: JSON.stringify(dataParsed)
            };
            this._notifyCallInvitationTimeout(notifyData); // for onIncomingCallTimeout
          } else {
            (0, _logger.zloginfo)(`[SignalingPluginCore][callUserStateChanged callback], ignore`);
          }
        } else if (callUserState === _zegoZimReactNative.ZIMCallUserState.Cancelled || callUserState === _zegoZimReactNative.ZIMCallUserState.BeCancelled) {
          // 3 or 10
          // |        |          Cancelled         |                                    BeCancelled                                     |
          // | caller | caller cancel OutgoingCall | OutgoingCall cancelled by zim server (e.g. caller network disconnection)           |
          // | callee |                            | IncomingCall cancelled by caller or zim server (e.g. caller network disconnection) |

          (0, _logger.zloginfo)(`[SignalingPluginCore][callUserStateChanged callback], detect ${callUserID} ${callUserState === _zegoZimReactNative.ZIMCallUserState.Cancelled ? 'Cancelled' : 'BeCancelled'}`);
          if (callUserID !== this._loginUser.userID) {
            (0, _logger.zloginfo)(`[SignalingPluginCore][callUserStateChanged callback], ignore`);
          } else {
            (0, _logger.zloginfo)(`[SignalingPluginCore][callUserStateChanged callback], notifyCallInvitationCancelled`);
            let dataParsed = callExtendedData ? JSON.parse(callExtendedData) : {};
            dataParsed.callID = callID;
            dataParsed.call_id = dataParsed.call_id ?? '';
            dataParsed.inviter = dataParsed.inviter ?? {
              userID: '',
              userName: ''
            };

            // when caller cancelled, inviter is empty
            callerID = callerID ?? dataParsed.inviter.userID;
            const notifyData = {
              callID,
              inviter: {
                id: callerID
              },
              data: JSON.stringify(dataParsed)
            };
            this._callIDUsers.delete(callID);
            this._callIDExtendedData.delete(callID);
            this._notifyCallInvitationCancelled(notifyData);
          }
        }
      });
    });
    _ZegoUIKitCorePlugin.default.getZIMPlugin().default.getInstance().on('tokenWillExpire', (zim, {
      second
    }) => {
      (0, _logger.zloginfo)('zim token will expire.');
      Object.keys(this._onRequireNewTokenCallbackMap).forEach(async callbackID => {
        if (this._onRequireNewTokenCallbackMap[callbackID]) {
          const token = await this._onRequireNewTokenCallbackMap[callbackID]();
          if (token) {
            this.renewToken(token);
          } else {
            (0, _logger.zlogerror)('Renew token failed: the returned token is abnormal');
          }
        }
      });
    });
  }
  _unregisterEngineCallback() {
    (0, _logger.zloginfo)('[Core]Unregister callback from ZIM...');
    _ZegoUIKitCorePlugin.default.getZIMPlugin().default.getInstance().off('error');
    _ZegoUIKitCorePlugin.default.getZIMPlugin().default.getInstance().off('connectionStateChanged');
    _ZegoUIKitCorePlugin.default.getZIMPlugin().default.getInstance().off('callUserStateChanged');
    _ZegoUIKitCorePlugin.default.getZIMPlugin().default.getInstance().off('callInvitationReceived');
    _ZegoUIKitCorePlugin.default.getZIMPlugin().default.getInstance().off('tokenWillExpire');
  }
  // ------- internal events exec ------
  _notifyConnectionStateChanged(notifyData) {
    Object.keys(this._onConnectionStateChangedCallbackMap).forEach(callbackID => {
      if (this._onConnectionStateChangedCallbackMap[callbackID]) {
        this._onConnectionStateChangedCallbackMap[callbackID](notifyData);
      }
    });
  }
  _notifyCallInvitationReceived(notifyData) {
    let callbackCount = Object.keys(this._onCallInvitationReceivedCallbackMap).length;
    (0, _logger.zloginfo)(`[ZegoSignalingPluginCore][_notifyCallInvitationReceived] notify count: ${callbackCount}`);
    Object.keys(this._onCallInvitationReceivedCallbackMap).forEach(callbackID => {
      if (this._onCallInvitationReceivedCallbackMap[callbackID]) {
        this._onCallInvitationReceivedCallbackMap[callbackID](notifyData);
      }
    });
  }
  _notifyCallInvitationCancelled(notifyData) {
    let callbackCount = Object.keys(this._onCallInvitationCancelledCallbackMap).length;
    (0, _logger.zloginfo)(`[ZegoSignalingPluginCore][_notifyCallInvitationCancelled] notify count: ${callbackCount}`);
    Object.keys(this._onCallInvitationCancelledCallbackMap).forEach(callbackID => {
      if (this._onCallInvitationCancelledCallbackMap[callbackID]) {
        this._onCallInvitationCancelledCallbackMap[callbackID](notifyData);
      }
    });
  }
  _notifyCallInvitationAccepted(notifyData) {
    Object.keys(this._onCallInvitationAcceptedCallbackMap).forEach(callbackID => {
      if (this._onCallInvitationAcceptedCallbackMap[callbackID]) {
        this._onCallInvitationAcceptedCallbackMap[callbackID](notifyData);
      }
    });
  }
  _notifyCallInvitationRejected(notifyData) {
    Object.keys(this._onCallInvitationRejectedCallbackMap).forEach(callbackID => {
      if (this._onCallInvitationRejectedCallbackMap[callbackID]) {
        this._onCallInvitationRejectedCallbackMap[callbackID](notifyData);
      }
    });
  }
  _notifyCallInvitationTimeout(notifyData) {
    Object.keys(this._onCallInvitationTimeoutCallbackMap).forEach(callbackID => {
      if (this._onCallInvitationTimeoutCallbackMap[callbackID]) {
        this._onCallInvitationTimeoutCallbackMap[callbackID](notifyData);
      }
    });
  }
  _notifyCallInviteesAnsweredTimeout(notifyData) {
    Object.keys(this._onCallInviteesAnsweredTimeoutCallbackMap).forEach(callbackID => {
      if (this._onCallInviteesAnsweredTimeoutCallbackMap[callbackID]) {
        this._onCallInviteesAnsweredTimeoutCallbackMap[callbackID](notifyData);
      }
    });
  }
  // ------- internal utils ------
  _resetData() {
    this._resetDataForLogout();
  }
  _resetDataForLogout() {
    this._isLogin = false;
    this._loginUser = {};
    this._callIDUsers.clear();
    this._callIDExtendedData.clear();
    this._connectionState = _zegoZimReactNative.ZIMConnectionState.Disconnected;
  }
  _getInviterIDByCallID(callID) {
    return this._callIDUsers.get(callID);
  }
  _getExtendedDataByCallID(callID) {
    return this._callIDExtendedData.get(callID);
  }
  _createHandle() {
    this._unregisterEngineCallback();
    this._registerEngineCallback();
    // live audio room
    _user_in_room_attributes_core.default.getInstance()._unregisterEngineCallback();
    _user_in_room_attributes_core.default.getInstance()._registerEngineCallback();
    _room_properties_core.default.getInstance()._unregisterEngineCallback();
    _room_properties_core.default.getInstance()._registerEngineCallback();
    _in_room_message_core.default.getInstance()._unregisterEngineCallback();
    _in_room_message_core.default.getInstance()._registerEngineCallback();
  }
  // ------- external utils ------
  getLocalUser() {
    return this._loginUser;
  }
  getCallIDByUserID(userID) {
    let callID = '';
    Array.from(this._callIDUsers.keys()).forEach(key => {
      const value = this._callIDUsers.get(key);
      if (userID === value) {
        callID = key;
        (0, _logger.zloginfo)(`[Core]getCallIDByUserID, ${userID} => ${callID}`);
      }
    });
    return callID;
  }
  // ------- external method ------
  getZIMInstance() {
    return _ZegoUIKitCorePlugin.default.getZIMPlugin().default.getInstance();
  }
  getVersion() {
    return _ZegoUIKitCorePlugin.default.getZIMPlugin().default.getVersion();
  }
  create(appConfig) {
    if (!_ZegoUIKitCorePlugin.default.getZIMPlugin().default.getInstance()) {
      const zim = _ZegoUIKitCorePlugin.default.getZIMPlugin().default.create(appConfig);
      if (!zim) {
        (0, _logger.zlogerror)('[Core]Create zim error.');
      } else {
        (0, _logger.zloginfo)('[Core]Create zim success.');
        this._createHandle();
      }
    } else {
      (0, _logger.zlogwarning)('[Core]Zim has already created.');
      this._createHandle();
    }
  }
  login(userInfo, token = '') {
    (0, _logger.zloginfo)('ZIM login...');
    return new Promise((resolve, reject) => {
      if (!this._isLogin) {
        _ZegoUIKitCorePlugin.default.getZIMPlugin().default.getInstance().login(userInfo, token).then(() => {
          (0, _logger.zloginfo)('ZIM login success.');
          (0, _logger.zloginfo)('[Core]Login success.');
          this._loginUser = userInfo;
          this._isLogin = true;
          resolve();
          (0, _logger.zloginfo)('notify _onLoginSuccessCallbackMap');
          Object.keys(this._onLoginSuccessCallbackMap).forEach(callbackID => {
            if (this._onLoginSuccessCallbackMap[callbackID]) {
              this._onLoginSuccessCallbackMap[callbackID]();
            }
          });
        }).catch(error => {
          if (error.code == _zegoZimReactNative.ZIMErrorCode.NetworkModuleUserHasAlreadyLogged) {
            (0, _logger.zloginfo)('ZIM login already.');
            (0, _logger.zloginfo)('[Core]Login already success.');
            resolve();
            (0, _logger.zloginfo)('notify _onLoginSuccessCallbackMap');
            Object.keys(this._onLoginSuccessCallbackMap).forEach(callbackID => {
              if (this._onLoginSuccessCallbackMap[callbackID]) {
                this._onLoginSuccessCallbackMap[callbackID]();
              }
            });
          } else {
            (0, _logger.zloginfo)(`ZIM login fail, error: ${error.code}`);
            reject(error);
          }
        });
      } else {
        (0, _logger.zloginfo)('[Core]Login already success.');
        resolve();
      }
    });
  }
  logout() {
    (0, _logger.zloginfo)('ZIM logout...');
    return _ZegoUIKitCorePlugin.default.getZIMPlugin().default.getInstance().logout().then(() => {
      (0, _logger.zloginfo)('[Core]Logout success.');
      this._resetDataForLogout();
      // live audio room
      _user_in_room_attributes_core.default.getInstance()._resetData();
    });
  }
  destroy() {
    (0, _logger.zloginfo)('ZIM destroy...');
    _ZegoUIKitCorePlugin.default.getZIMPlugin().default.getInstance().destroy();
    (0, _logger.zloginfo)('[Core]Destroy success.');
    this._resetData();
  }
  setAdvancedConfig(key, value) {
    (0, _logger.zloginfo)(`[Core]setAdvancedConfig, key: ${key}, value: ${value}`);
    _ZegoUIKitCorePlugin.default.getZIMPlugin().default.setAdvancedConfig(key, value);
  }
  invite(invitees, config) {
    return new Promise((resolve, reject) => {
      _ZegoUIKitCorePlugin.default.getZIMPlugin().default.getInstance().callInvite(invitees, config).then(({
        callID,
        timeout,
        errorInvitees,
        errorUserList
      }) => {
        _report.default.reportEvent('callInvite', {
          'invitees': JSON.stringify(invitees),
          'count': invitees.length,
          'error_userlist': JSON.stringify(errorUserList),
          'error_count': errorUserList.length,
          'call_id': callID,
          'extended_data': config.extendedData,
          'error': 0,
          'msg': ''
        });
        this._callIDUsers.set(callID, this._loginUser.userID);
        this._callIDExtendedData.set(callID, config.extendedData);
        if (!errorInvitees || !errorInvitees.length) {
          (0, _logger.zloginfo)(`[Core]Invite done, call id: ${callID}`);
          resolve({
            ...new _defines.default('', ''),
            callID,
            errorInvitees: []
          });
        } else {
          const errorInviteeIDs = [];
          errorInvitees.forEach(errorInvitee => {
            const desc = errorInvitee.state === _zegoZimReactNative.ZIMCallUserState.Offline ? 'offine' : errorInvitee.state === _zegoZimReactNative.ZIMCallUserState.Inviting ? 'inviting' : '';
            (0, _logger.zlogwarning)(`[Core]Invite error, invitee id: ${errorInvitee.userID}, invitee state: ${errorInvitee.state}, state desc: ${desc}`);
            errorInviteeIDs.push(errorInvitee.userID);
          });
          resolve({
            ...new _defines.default('', ''),
            callID,
            errorInvitees: errorInviteeIDs
          });
        }
      }).catch(error => {
        _report.default.reportEvent('callInvite', {
          'invitees': JSON.stringify(invitees),
          'count': invitees.length,
          'call_id': '',
          'extended_data': config.extendedData,
          'error': error.code,
          'msg': error.message
        });
        reject(error);
      });
    });
  }
  cancel(invitees, callID, config) {
    return new Promise((resolve, reject) => {
      _ZegoUIKitCorePlugin.default.getZIMPlugin().default.getInstance().callCancel(invitees, callID, config).then(({
        callID,
        errorInvitees
      }) => {
        this._callIDUsers.delete(callID);
        this._callIDExtendedData.delete(callID);
        if (!errorInvitees || !errorInvitees.length) {
          (0, _logger.zloginfo)(`[Core]Cancel invitation done, call id: ${callID}`);
          resolve({
            ...new _defines.default('', ''),
            callID,
            errorInvitees: []
          });
        } else {
          errorInvitees.forEach(inviteeID => {
            (0, _logger.zlogwarning)(`[Core]Cancel invitation error, invitee id: ${inviteeID}`);
          });
          resolve({
            ...new _defines.default('', ''),
            callID,
            errorInvitees
          });
        }
      }).catch(error => {
        (0, _logger.zloginfo)(`[Core]Cancel invitation failed, call id: ${callID}, error: ${error}`);
        reject(error);
      });
    });
  }
  accept(callID, config) {
    return new Promise((resolve, reject) => {
      _ZegoUIKitCorePlugin.default.getZIMPlugin().default.getInstance().callAccept(callID, config).then(({
        callID
      }) => {
        (0, _logger.zloginfo)(`[Core]Accept invitation done, call id: ${callID}`);
        resolve(new _defines.default('', '', {
          callID
        }));
      }).catch(error => {
        reject(error);
      });
    });
  }
  reject(callID, config) {
    return new Promise((resolve, reject) => {
      _ZegoUIKitCorePlugin.default.getZIMPlugin().default.getInstance().callReject(callID, config).then(({
        callID
      }) => {
        (0, _logger.zloginfo)(`[Core]Reject invitation done, call id: ${callID}`);
        this._callIDUsers.delete(callID);
        this._callIDExtendedData.delete(callID);
        resolve(new _defines.default('', '', {
          callID
        }));
      }).catch(error => {
        (0, _logger.zloginfo)(`[Core]Reject invitation error, call id: ${callID}, error: ${error.code}`);
        reject(error);
      });
    });
  }
  queryCallList(config) {
    return new Promise((resolve, reject) => {
      _ZegoUIKitCorePlugin.default.getZIMPlugin().default.getInstance().queryCallInvitationList(config).then(({
        callList,
        nextFlag: newFlag
      }) => {
        (0, _logger.zloginfo)(`[Core]Query invitation list done, nextFlag: ${newFlag}, calllist: ${callList.length}`);
        const data = {
          callList: callList,
          nextFlag: newFlag
        };
        resolve(data);
      }).catch(error => {
        reject(error);
      });
    });
  }
  renewToken(token) {
    return new Promise((resolve, reject) => {
      _ZegoUIKitCorePlugin.default.getZIMPlugin().default.getInstance().renewToken(token).then(() => {
        (0, _logger.zloginfo)(`Renew zim token success, token: ${token}`);
        resolve();
      }).catch(error => {
        (0, _logger.zlogerror)(`Renew zim token failed. code: ${error.code}, message: ${error.message}`);
        reject(error);
      });
    });
  }

  // ------- external events register ------
  onConnectionStateChanged(callbackID, callback) {
    if (typeof callback !== 'function') {
      if (callbackID in this._onConnectionStateChangedCallbackMap) {
        (0, _logger.zloginfo)('[Core][onConnectionStateChanged] Remove callback for: [', callbackID, '] because callback is not a valid function!');
        delete this._onConnectionStateChangedCallbackMap[callbackID];
      }
    } else {
      this._onConnectionStateChangedCallbackMap[callbackID] = callback;
    }
  }
  onCallInvitationReceived(callbackID, callback) {
    if (typeof callback !== 'function') {
      if (callbackID in this._onCallInvitationReceivedCallbackMap) {
        (0, _logger.zloginfo)('[Core][onCallInvitationReceived] Remove callback for: [', callbackID, '] because callback is not a valid function!');
        delete this._onCallInvitationReceivedCallbackMap[callbackID];
      }
    } else {
      this._onCallInvitationReceivedCallbackMap[callbackID] = callback;
    }
  }
  onCallInvitationCancelled(callbackID, callback) {
    if (typeof callback !== 'function') {
      if (callbackID in this._onCallInvitationCancelledCallbackMap) {
        (0, _logger.zloginfo)('[Core][onCallInvitationCancelled] Remove callback for: [', callbackID, ']');
        delete this._onCallInvitationCancelledCallbackMap[callbackID];
      }
    } else {
      this._onCallInvitationCancelledCallbackMap[callbackID] = callback;
    }
  }
  onCallInvitationAccepted(callbackID, callback) {
    if (typeof callback !== 'function') {
      if (callbackID in this._onCallInvitationAcceptedCallbackMap) {
        (0, _logger.zloginfo)('[Core][onCallInvitationAccepted] Remove callback for: [', callbackID, '] because callback is not a valid function!');
        delete this._onCallInvitationAcceptedCallbackMap[callbackID];
      }
    } else {
      this._onCallInvitationAcceptedCallbackMap[callbackID] = callback;
    }
  }
  onCallInvitationRejected(callbackID, callback) {
    if (typeof callback !== 'function') {
      if (callbackID in this._onCallInvitationRejectedCallbackMap) {
        (0, _logger.zloginfo)('[Core][onCallInvitationRejected] Remove callback for: [', callbackID, '] because callback is not a valid function!');
        delete this._onCallInvitationRejectedCallbackMap[callbackID];
      }
    } else {
      this._onCallInvitationRejectedCallbackMap[callbackID] = callback;
    }
  }
  onCallInvitationTimeout(callbackID, callback) {
    if (typeof callback !== 'function') {
      if (callbackID in this._onCallInvitationTimeoutCallbackMap) {
        (0, _logger.zloginfo)('[Core][onCallInvitationTimeout] Remove callback for: [', callbackID, '] because callback is not a valid function!');
        delete this._onCallInvitationTimeoutCallbackMap[callbackID];
      }
    } else {
      this._onCallInvitationTimeoutCallbackMap[callbackID] = callback;
    }
  }
  onCallInviteesAnsweredTimeout(callbackID, callback) {
    if (typeof callback !== 'function') {
      if (callbackID in this._onCallInviteesAnsweredTimeoutCallbackMap) {
        (0, _logger.zloginfo)('[Core][onCallInviteesAnsweredTimeout] Remove callback for: [', callbackID, '] because callback is not a valid function!');
        delete this._onCallInviteesAnsweredTimeoutCallbackMap[callbackID];
      }
    } else {
      this._onCallInviteesAnsweredTimeoutCallbackMap[callbackID] = callback;
    }
  }
  onRequireNewToken(callbackID, callback) {
    if (typeof callback !== 'function') {
      if (callbackID in this._onRequireNewTokenCallbackMap) {
        (0, _logger.zloginfo)('[Core][onRequireNewToken] Remove callback for: [', callbackID, '] because callback is not a valid function!');
        delete this._onRequireNewTokenCallbackMap[callbackID];
      }
    } else {
      this._onRequireNewTokenCallbackMap[callbackID] = callback;
    }
  }
  onLoginSuccess(callbackID, callback) {
    if (typeof callback !== 'function') {
      if (callbackID in this._onLoginSuccessCallbackMap) {
        delete this._onLoginSuccessCallbackMap[callbackID];
        (0, _logger.zloginfo)(`[onLoginSuccess] Remove callback for: ${callbackID}`);
      }
    } else {
      this._onLoginSuccessCallbackMap[callbackID] = callback;
      if (this._isLogin) {
        (0, _logger.zloginfo)(`[onLoginSuccess] already login, execute callback directly.`);
        callback();
      }
    }
  }
}
exports.default = ZegoSignalingPluginCore;
_ZegoSignalingPluginCore = ZegoSignalingPluginCore;
_defineProperty(ZegoSignalingPluginCore, "shared", void 0);
//# sourceMappingURL=index.js.map