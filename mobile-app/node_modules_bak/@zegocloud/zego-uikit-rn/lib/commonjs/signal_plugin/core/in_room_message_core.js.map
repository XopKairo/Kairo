{"version":3,"names":["_zegoZimReactNative","require","_logger","_ZegoUIKitCorePlugin","_interopRequireDefault","_ZegoPluginRoomMessageCore","e","__esModule","default","_defineProperty","r","t","_toPropertyKey","Object","defineProperty","value","enumerable","configurable","writable","i","_toPrimitive","Symbol","toPrimitive","call","TypeError","String","Number","ZegoPluginRoomMessageCore","constructor","shared","getInstance","_registerEngineCallback","ZegoUIKitCorePlugin","getZIMPlugin","on","zim","messageList","fromConversationID","zloginfo","message","type","ZIMMessageType","Command","command","commandMessage","Uint8Array","values","jsonText","decodeURIComponent","escape","fromCharCode","Array","from","notifyData","roomID","senderUserID","timestamp","_notifyInRoomCommandMessageReceived","Text","textMessage","_notifyInRoomTextMessageReceived","_unregisterEngineCallback","off","keys","_onInRoomTextMessageReceivedCallbackMap","forEach","callbackID","_onInRoomCommandMessageReceivedCallbackMap","sendInRoomTextMessage","Promise","resolve","reject","sendMessage","ZIMConversationType","Room","priority","ZIMMessagePriority","Low","then","_zimMessage","catch","error","zlogwarning","JSON","stringify","sendInRoomCommandMessage","unescape","encodeURIComponent","map","val","charCodeAt","onInRoomTextMessageReceived","callback","zlogerror","onInRoomCommandMessageReceived","exports"],"sources":["in_room_message_core.ts"],"sourcesContent":["import { \n  ZIMCommandMessage, \n  ZIMConversationType,\n  ZIMError,\n  ZIMEventOfReceiveConversationMessageResult,\n  ZIMMessagePriority,\n  ZIMMessageSentResult,\n  ZIMMessageType, \n  ZIMTextMessage,\n} from 'zego-zim-react-native';\nimport { zlogerror, zloginfo, zlogwarning } from '../utils/logger';\nimport ZegoUIKitCorePlugin from \"../../components/internal/ZegoUIKitCorePlugin\";\n\nexport default class ZegoPluginRoomMessageCore {\n  static shared: ZegoPluginRoomMessageCore;\n\n  constructor() {\n    if (!ZegoPluginRoomMessageCore.shared) {\n      ZegoPluginRoomMessageCore.shared = this;\n    }\n    return ZegoPluginRoomMessageCore.shared;\n  }\n  static getInstance() {\n    if (!ZegoPluginRoomMessageCore.shared) {\n      ZegoPluginRoomMessageCore.shared = new ZegoPluginRoomMessageCore();\n    }\n    return ZegoPluginRoomMessageCore.shared;\n  }\n\n  _onInRoomTextMessageReceivedCallbackMap: { [index: string]: (notifyData: { \n    message: string; \n    roomID: string;\n    senderUserID: string;\n    timestamp: number;\n  }) => void } = {};\n\n  _onInRoomCommandMessageReceivedCallbackMap: { [index: string]: (notifyData: { \n    message: string; \n    roomID: string;\n    senderUserID: string;\n    timestamp: number;\n  }) => void } = {};\n\n  _registerEngineCallback() {\n    ZegoUIKitCorePlugin.getZIMPlugin().default.getInstance().on('receiveRoomMessage', (zim: any, { messageList, fromConversationID }: ZIMEventOfReceiveConversationMessageResult) => {\n      zloginfo(\n        '[Core][receiveRoomMessage callback]',\n        messageList,\n        fromConversationID\n      );\n      for (const message of messageList) {\n        if (message.type === ZIMMessageType.Command) {\n          const command = message as ZIMCommandMessage;\n          var commandMessage: Uint8Array | number[];\n          \n          if (command.message instanceof Uint8Array) {\n            commandMessage = command.message;\n          } else {\n            commandMessage = Object.values(command.message);\n          }\n\n          var jsonText = decodeURIComponent(escape(String.fromCharCode(...Array.from(commandMessage))));\n\n          const notifyData = {\n            message: jsonText,\n            roomID: fromConversationID,\n            senderUserID: message.senderUserID,\n            timestamp: message.timestamp\n          }\n          this._notifyInRoomCommandMessageReceived(notifyData);\n        } else if (message.type === ZIMMessageType.Text) {\n          const textMessage = message as ZIMTextMessage;\n          const notifyData = {\n            message: textMessage.message,\n            roomID: fromConversationID,\n            senderUserID: message.senderUserID,\n            timestamp: message.timestamp\n          }\n          this._notifyInRoomTextMessageReceived(notifyData);\n        }\n      }\n    });\n    zloginfo('[ZegoPluginRoomMessageCore]Register callback for ZIM...');\n  }\n\n  _unregisterEngineCallback() {\n    zloginfo('[ZegoPluginRoomMessageCore]Unregister callback from ZIM...');\n    ZegoUIKitCorePlugin.getZIMPlugin().default.getInstance().off('receiveRoomMessage');\n  }\n\n  _notifyInRoomTextMessageReceived(notifyData: { \n    message: string; \n    roomID: string;\n    senderUserID: string;\n    timestamp: number;\n   }) {\n    zloginfo(`[Core]NotifyInRoomTextMessageReceived, data: ${notifyData}`);\n    Object.keys(this._onInRoomTextMessageReceivedCallbackMap).forEach(\n      (callbackID) => {\n        if (this._onInRoomTextMessageReceivedCallbackMap[callbackID]) {\n          this._onInRoomTextMessageReceivedCallbackMap[callbackID](notifyData);\n        }\n      }\n    );\n  }\n\n  _notifyInRoomCommandMessageReceived(notifyData: {\n    message: string;\n    roomID: string;\n    senderUserID: string;\n    timestamp: number;\n  }) {\n    zloginfo(`[Core]NotifyInRoomCommandMessageReceived, data: ${notifyData}`);\n    Object.keys(this._onInRoomCommandMessageReceivedCallbackMap).forEach(\n      (callbackID) => {\n        if (this._onInRoomCommandMessageReceivedCallbackMap[callbackID]) {\n          this._onInRoomCommandMessageReceivedCallbackMap[callbackID](\n            notifyData\n          );\n        }\n      }\n    );\n  }\n\n  sendInRoomTextMessage(roomID: string, message: string): Promise<void> {\n    return new Promise((resolve, reject) => {\n      const textMessage = {\n        type: ZIMMessageType.Text,\n        message: message,\n      } as ZIMTextMessage\n      ZegoUIKitCorePlugin.getZIMPlugin().default.getInstance()\n      .sendMessage(textMessage, roomID, ZIMConversationType.Room, {priority: ZIMMessagePriority.Low}, null)\n      .then(({ message: _zimMessage }: ZIMMessageSentResult) => {\n        zloginfo(`[Core]sendInRoomTextMessage done, roomID: ${roomID}, message: ${message}`);\n        resolve();\n      })\n      .catch((error: ZIMError) => {\n        zlogwarning(`[Core]sendInRoomTextMessage error, roomID: ${roomID}, message: ${message}, error: ${JSON.stringify(error)}`);\n        reject(error);\n      })\n    });\n  }\n\n  sendInRoomCommandMessage(roomID: string, message: string): Promise<void> {\n    var command = new Uint8Array(Array.from(unescape(encodeURIComponent(message))).map((val) => val.charCodeAt(0)));\n    return new Promise((resolve, reject) => {\n      const commandMessage = {\n        type: ZIMMessageType.Command,\n        message: command,\n      } as ZIMCommandMessage\n      ZegoUIKitCorePlugin.getZIMPlugin().default.getInstance()\n      .sendMessage(commandMessage, roomID, ZIMConversationType.Room, {priority: ZIMMessagePriority.Low}, null)\n      .then(({ message: _zimMessage }: ZIMMessageSentResult) => {\n        zloginfo(`[Core]sendInRoomCommandMessage done, roomID: ${roomID}, message: ${message}`);\n        resolve();\n      })\n      .catch((error: ZIMError) => {\n        zlogwarning(`[Core]sendInRoomCommandMessage error, roomID: ${roomID}, message: ${message}, error: ${JSON.stringify(error)}`);\n        reject(error);\n      })\n    });\n  }\n\n  onInRoomTextMessageReceived(callbackID: string, callback: (notifyData: { message: string; roomID: string; }) => void) {\n    if (!ZegoUIKitCorePlugin.getZIMPlugin().default.getInstance()) {\n      zlogerror('[ZegoPluginRoomPropertiesCore]Please initialize it first.');\n    }\n    if (typeof callback !== 'function') {\n      if (callbackID in this._onInRoomTextMessageReceivedCallbackMap) {\n        zloginfo(\n          '[Core][onRoomPropertyUpdated] Remove callback for: [',\n          callbackID,\n          '] because callback is not a valid function!'\n        );\n        delete this._onInRoomTextMessageReceivedCallbackMap[callbackID];\n      }\n    } else {\n      this._onInRoomTextMessageReceivedCallbackMap[callbackID] = callback;\n    }\n  }\n  onInRoomCommandMessageReceived(callbackID: string, callback: (notifyData: {\n    message: string;\n    roomID: string;\n  }) => void) {\n    if (typeof callback !== 'function') {\n      if (callbackID in this._onInRoomCommandMessageReceivedCallbackMap) {\n        zloginfo(\n          '[Core][onInRoomCommandMessageReceived] Remove callback for: [',\n          callbackID,\n          '] because callback is not a valid function!'\n        );\n        delete this._onInRoomCommandMessageReceivedCallbackMap[callbackID];\n      }\n    } else {\n      this._onInRoomCommandMessageReceivedCallbackMap[callbackID] = callback;\n    }\n  }\n\n}"],"mappings":"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","ignoreList":[]}