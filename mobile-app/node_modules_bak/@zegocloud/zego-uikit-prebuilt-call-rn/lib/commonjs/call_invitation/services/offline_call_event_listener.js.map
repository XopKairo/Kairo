{"version":3,"names":["_reactNative","require","_zegoUikitRn","_interopRequireWildcard","_logger","_package_version","_inner_text_helper","_interopRequireDefault","_callkit","_notification_helper","e","__esModule","default","t","WeakMap","r","n","o","i","f","__proto__","has","get","set","hasOwnProperty","call","Object","defineProperty","getOwnPropertyDescriptor","_defineProperty","_toPropertyKey","value","enumerable","configurable","writable","_toPrimitive","Symbol","toPrimitive","TypeError","String","Number","OfflineCallEventListener","constructor","getInstance","_instance","useSystemCallingUI","plugins","_isSystemCalling","ZegoUIKit","installPlugins","logComponentsVersion","Map","getPackageVersion","signalingPlugin","getSignalingPlugin","getZegoUIKitSignalingPlugin","setBackgroundMessageHandler","setAndroidOfflineDataHandler","data","zloginfo","NotificationHelper","init","cancelInvitation","operation_type","showOfflineNotification","zim_call_id","Date","now","toString","dismissNotification","TAG","setIOSOfflineDataHandler","callUUID","setAdvancedConfig","ZegoUIKitLogger","logFlush","config","grantPermissions","setupOnlineCallKit","Platform","OS","Version","grantednNtification","PermissionsAndroid","check","PERMISSIONS","POST_NOTIFICATIONS","ungrantedPermissions","isNotificationGranted","push","requestMultiple","then","ringtoneConfig","incomingCallFileName","RNCallKit","setupCallKit","incomingDeclineButtonText","InnerTextHelper","instance","getInnerText","incomingCallPageDeclineButton","incomingAcceptButtonText","incomingCallPageAcceptButton","uninit","exports"],"sources":["offline_call_event_listener.js"],"sourcesContent":["import { PermissionsAndroid, Platform } from 'react-native';\n\nimport ZegoUIKit, { ZegoUIKitLogger } from '@zegocloud/zego-uikit-rn';\n\nimport { zloginfo } from '../../utils/logger';\nimport { getPackageVersion } from '../../utils/package_version';\nimport InnerTextHelper from '../services/inner_text_helper';\nimport RNCallKit from './callkit';\nimport NotificationHelper from './notification_helper';\n\nexport default class OfflineCallEventListener {\n    TAG = 'OfflineCallEventListener';\n\n    _instance;\n    config = {};\n    _isSystemCalling = false;\n\n    constructor() { }\n    static getInstance() {\n        return this._instance || (this._instance = new OfflineCallEventListener());\n    }\n\n    useSystemCallingUI(plugins = []) {\n        this._isSystemCalling = true;\n\n        ZegoUIKit.installPlugins(plugins);\n        ZegoUIKit.logComponentsVersion(new Map([['PrebuiltCall', getPackageVersion()]]));\n        const signalingPlugin = ZegoUIKit.getSignalingPlugin().getZegoUIKitSignalingPlugin();\n\n        // https://doc-zh.zego.im/article/17416\n        signalingPlugin.getInstance().setBackgroundMessageHandler();\n\n        signalingPlugin.getInstance().setAndroidOfflineDataHandler(async (data) => {\n            zloginfo('OfflineDataHandler: ', data);\n\n            NotificationHelper.getInstance().init(plugins)\n\n            const cancelInvitation = data && data.operation_type === \"cancel_invitation\"\n            if (!cancelInvitation) {\n              NotificationHelper.getInstance().showOfflineNotification(data.zim_call_id, Date.now().toString(), data)\n            } else {\n              NotificationHelper.getInstance().dismissNotification(data.zim_call_id, 'BeCancelled', this.TAG)\n            }\n        })\n\n        signalingPlugin.getInstance().setIOSOfflineDataHandler((data, callUUID) => {\n            zloginfo(\"setIOSOfflineDataHandler\", callUUID, data)\n\n            ZegoUIKit.getSignalingPlugin().setAdvancedConfig('zim_voip_call_id', data.zim_call_id);\n\n            NotificationHelper.getInstance().init()\n            NotificationHelper.getInstance().showOfflineNotification(data.zim_call_id, callUUID, data)\n        });\n\n        ZegoUIKitLogger.logFlush()\n    }\n\n    init(config) {\n      zloginfo('######OfflineCallEventListener init', config);\n      this.config = config;\n\n      // Setup for background invitation\n      if (!this._isSystemCalling) return;\n\n      this.grantPermissions();\n\n      this.setupOnlineCallKit();\n    }\n\n    async grantPermissions() {\n      if (Platform.OS !== 'android') {\n        return;\n      }\n\n      // for android\n      if (Platform.Version < 33) {\n        return;\n      }\n\n      // Notification\n      let grantednNtification = PermissionsAndroid.check(\n        PermissionsAndroid.PERMISSIONS.POST_NOTIFICATIONS,\n      );\n      const ungrantedPermissions = [];\n      try {\n        const isNotificationGranted = await grantednNtification;\n        if (!isNotificationGranted) {\n          ungrantedPermissions.push(PermissionsAndroid.PERMISSIONS.POST_NOTIFICATIONS);\n        }\n      } catch {\n        ungrantedPermissions.push(PermissionsAndroid.PERMISSIONS.POST_NOTIFICATIONS);\n      }\n      PermissionsAndroid.requestMultiple(ungrantedPermissions).then(\n        data => {\n          zloginfo('requestMultiple', data);\n        },\n      );\n    }\n\n    // For Android\n    setupOnlineCallKit() {\n      const {\n        ringtoneConfig,\n      } = this.config;\n\n      if (!ringtoneConfig) {\n        zloginfo('ringtoneConfig is required for calling notification');\n      }\n\n      if (Platform.OS === 'android') {\n\n        if (ringtoneConfig && ringtoneConfig.incomingCallFileName) {\n          RNCallKit.setupCallKit({\n            incomingCallFileName: ringtoneConfig.incomingCallFileName,\n            incomingDeclineButtonText: InnerTextHelper.instance().getInnerText().incomingCallPageDeclineButton,\n            incomingAcceptButtonText: InnerTextHelper.instance().getInnerText().incomingCallPageAcceptButton,\n          });\n        }\n      }\n    }\n\n    uninit() {\n        zloginfo('######OfflineCallEventListener uninit');\n    }\n}"],"mappings":"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","ignoreList":[]}