{"version":3,"names":["PermissionsAndroid","Platform","ZegoUIKit","ZegoUIKitLogger","zloginfo","getPackageVersion","InnerTextHelper","RNCallKit","NotificationHelper","OfflineCallEventListener","constructor","_defineProperty","getInstance","_instance","useSystemCallingUI","plugins","_isSystemCalling","installPlugins","logComponentsVersion","Map","signalingPlugin","getSignalingPlugin","getZegoUIKitSignalingPlugin","setBackgroundMessageHandler","setAndroidOfflineDataHandler","data","init","cancelInvitation","operation_type","showOfflineNotification","zim_call_id","Date","now","toString","dismissNotification","TAG","setIOSOfflineDataHandler","callUUID","setAdvancedConfig","logFlush","config","grantPermissions","setupOnlineCallKit","OS","Version","grantednNtification","check","PERMISSIONS","POST_NOTIFICATIONS","ungrantedPermissions","isNotificationGranted","push","requestMultiple","then","ringtoneConfig","incomingCallFileName","setupCallKit","incomingDeclineButtonText","instance","getInnerText","incomingCallPageDeclineButton","incomingAcceptButtonText","incomingCallPageAcceptButton","uninit"],"sources":["offline_call_event_listener.js"],"sourcesContent":["import { PermissionsAndroid, Platform } from 'react-native';\n\nimport ZegoUIKit, { ZegoUIKitLogger } from '@zegocloud/zego-uikit-rn';\n\nimport { zloginfo } from '../../utils/logger';\nimport { getPackageVersion } from '../../utils/package_version';\nimport InnerTextHelper from '../services/inner_text_helper';\nimport RNCallKit from './callkit';\nimport NotificationHelper from './notification_helper';\n\nexport default class OfflineCallEventListener {\n    TAG = 'OfflineCallEventListener';\n\n    _instance;\n    config = {};\n    _isSystemCalling = false;\n\n    constructor() { }\n    static getInstance() {\n        return this._instance || (this._instance = new OfflineCallEventListener());\n    }\n\n    useSystemCallingUI(plugins = []) {\n        this._isSystemCalling = true;\n\n        ZegoUIKit.installPlugins(plugins);\n        ZegoUIKit.logComponentsVersion(new Map([['PrebuiltCall', getPackageVersion()]]));\n        const signalingPlugin = ZegoUIKit.getSignalingPlugin().getZegoUIKitSignalingPlugin();\n\n        // https://doc-zh.zego.im/article/17416\n        signalingPlugin.getInstance().setBackgroundMessageHandler();\n\n        signalingPlugin.getInstance().setAndroidOfflineDataHandler(async (data) => {\n            zloginfo('OfflineDataHandler: ', data);\n\n            NotificationHelper.getInstance().init(plugins)\n\n            const cancelInvitation = data && data.operation_type === \"cancel_invitation\"\n            if (!cancelInvitation) {\n              NotificationHelper.getInstance().showOfflineNotification(data.zim_call_id, Date.now().toString(), data)\n            } else {\n              NotificationHelper.getInstance().dismissNotification(data.zim_call_id, 'BeCancelled', this.TAG)\n            }\n        })\n\n        signalingPlugin.getInstance().setIOSOfflineDataHandler((data, callUUID) => {\n            zloginfo(\"setIOSOfflineDataHandler\", callUUID, data)\n\n            ZegoUIKit.getSignalingPlugin().setAdvancedConfig('zim_voip_call_id', data.zim_call_id);\n\n            NotificationHelper.getInstance().init()\n            NotificationHelper.getInstance().showOfflineNotification(data.zim_call_id, callUUID, data)\n        });\n\n        ZegoUIKitLogger.logFlush()\n    }\n\n    init(config) {\n      zloginfo('######OfflineCallEventListener init', config);\n      this.config = config;\n\n      // Setup for background invitation\n      if (!this._isSystemCalling) return;\n\n      this.grantPermissions();\n\n      this.setupOnlineCallKit();\n    }\n\n    async grantPermissions() {\n      if (Platform.OS !== 'android') {\n        return;\n      }\n\n      // for android\n      if (Platform.Version < 33) {\n        return;\n      }\n\n      // Notification\n      let grantednNtification = PermissionsAndroid.check(\n        PermissionsAndroid.PERMISSIONS.POST_NOTIFICATIONS,\n      );\n      const ungrantedPermissions = [];\n      try {\n        const isNotificationGranted = await grantednNtification;\n        if (!isNotificationGranted) {\n          ungrantedPermissions.push(PermissionsAndroid.PERMISSIONS.POST_NOTIFICATIONS);\n        }\n      } catch {\n        ungrantedPermissions.push(PermissionsAndroid.PERMISSIONS.POST_NOTIFICATIONS);\n      }\n      PermissionsAndroid.requestMultiple(ungrantedPermissions).then(\n        data => {\n          zloginfo('requestMultiple', data);\n        },\n      );\n    }\n\n    // For Android\n    setupOnlineCallKit() {\n      const {\n        ringtoneConfig,\n      } = this.config;\n\n      if (!ringtoneConfig) {\n        zloginfo('ringtoneConfig is required for calling notification');\n      }\n\n      if (Platform.OS === 'android') {\n\n        if (ringtoneConfig && ringtoneConfig.incomingCallFileName) {\n          RNCallKit.setupCallKit({\n            incomingCallFileName: ringtoneConfig.incomingCallFileName,\n            incomingDeclineButtonText: InnerTextHelper.instance().getInnerText().incomingCallPageDeclineButton,\n            incomingAcceptButtonText: InnerTextHelper.instance().getInnerText().incomingCallPageAcceptButton,\n          });\n        }\n      }\n    }\n\n    uninit() {\n        zloginfo('######OfflineCallEventListener uninit');\n    }\n}"],"mappings":";;;AAAA,SAASA,kBAAkB,EAAEC,QAAQ,QAAQ,cAAc;AAE3D,OAAOC,SAAS,IAAIC,eAAe,QAAQ,0BAA0B;AAErE,SAASC,QAAQ,QAAQ,oBAAoB;AAC7C,SAASC,iBAAiB,QAAQ,6BAA6B;AAC/D,OAAOC,eAAe,MAAM,+BAA+B;AAC3D,OAAOC,SAAS,MAAM,WAAW;AACjC,OAAOC,kBAAkB,MAAM,uBAAuB;AAEtD,eAAe,MAAMC,wBAAwB,CAAC;EAO1CC,WAAWA,CAAA,EAAG;IAAAC,eAAA,cANR,0BAA0B;IAAAA,eAAA;IAAAA,eAAA,iBAGvB,CAAC,CAAC;IAAAA,eAAA,2BACQ,KAAK;EAER;EAChB,OAAOC,WAAWA,CAAA,EAAG;IACjB,OAAO,IAAI,CAACC,SAAS,KAAK,IAAI,CAACA,SAAS,GAAG,IAAIJ,wBAAwB,CAAC,CAAC,CAAC;EAC9E;EAEAK,kBAAkBA,CAACC,OAAO,GAAG,EAAE,EAAE;IAC7B,IAAI,CAACC,gBAAgB,GAAG,IAAI;IAE5Bd,SAAS,CAACe,cAAc,CAACF,OAAO,CAAC;IACjCb,SAAS,CAACgB,oBAAoB,CAAC,IAAIC,GAAG,CAAC,CAAC,CAAC,cAAc,EAAEd,iBAAiB,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;IAChF,MAAMe,eAAe,GAAGlB,SAAS,CAACmB,kBAAkB,CAAC,CAAC,CAACC,2BAA2B,CAAC,CAAC;;IAEpF;IACAF,eAAe,CAACR,WAAW,CAAC,CAAC,CAACW,2BAA2B,CAAC,CAAC;IAE3DH,eAAe,CAACR,WAAW,CAAC,CAAC,CAACY,4BAA4B,CAAC,MAAOC,IAAI,IAAK;MACvErB,QAAQ,CAAC,sBAAsB,EAAEqB,IAAI,CAAC;MAEtCjB,kBAAkB,CAACI,WAAW,CAAC,CAAC,CAACc,IAAI,CAACX,OAAO,CAAC;MAE9C,MAAMY,gBAAgB,GAAGF,IAAI,IAAIA,IAAI,CAACG,cAAc,KAAK,mBAAmB;MAC5E,IAAI,CAACD,gBAAgB,EAAE;QACrBnB,kBAAkB,CAACI,WAAW,CAAC,CAAC,CAACiB,uBAAuB,CAACJ,IAAI,CAACK,WAAW,EAAEC,IAAI,CAACC,GAAG,CAAC,CAAC,CAACC,QAAQ,CAAC,CAAC,EAAER,IAAI,CAAC;MACzG,CAAC,MAAM;QACLjB,kBAAkB,CAACI,WAAW,CAAC,CAAC,CAACsB,mBAAmB,CAACT,IAAI,CAACK,WAAW,EAAE,aAAa,EAAE,IAAI,CAACK,GAAG,CAAC;MACjG;IACJ,CAAC,CAAC;IAEFf,eAAe,CAACR,WAAW,CAAC,CAAC,CAACwB,wBAAwB,CAAC,CAACX,IAAI,EAAEY,QAAQ,KAAK;MACvEjC,QAAQ,CAAC,0BAA0B,EAAEiC,QAAQ,EAAEZ,IAAI,CAAC;MAEpDvB,SAAS,CAACmB,kBAAkB,CAAC,CAAC,CAACiB,iBAAiB,CAAC,kBAAkB,EAAEb,IAAI,CAACK,WAAW,CAAC;MAEtFtB,kBAAkB,CAACI,WAAW,CAAC,CAAC,CAACc,IAAI,CAAC,CAAC;MACvClB,kBAAkB,CAACI,WAAW,CAAC,CAAC,CAACiB,uBAAuB,CAACJ,IAAI,CAACK,WAAW,EAAEO,QAAQ,EAAEZ,IAAI,CAAC;IAC9F,CAAC,CAAC;IAEFtB,eAAe,CAACoC,QAAQ,CAAC,CAAC;EAC9B;EAEAb,IAAIA,CAACc,MAAM,EAAE;IACXpC,QAAQ,CAAC,qCAAqC,EAAEoC,MAAM,CAAC;IACvD,IAAI,CAACA,MAAM,GAAGA,MAAM;;IAEpB;IACA,IAAI,CAAC,IAAI,CAACxB,gBAAgB,EAAE;IAE5B,IAAI,CAACyB,gBAAgB,CAAC,CAAC;IAEvB,IAAI,CAACC,kBAAkB,CAAC,CAAC;EAC3B;EAEA,MAAMD,gBAAgBA,CAAA,EAAG;IACvB,IAAIxC,QAAQ,CAAC0C,EAAE,KAAK,SAAS,EAAE;MAC7B;IACF;;IAEA;IACA,IAAI1C,QAAQ,CAAC2C,OAAO,GAAG,EAAE,EAAE;MACzB;IACF;;IAEA;IACA,IAAIC,mBAAmB,GAAG7C,kBAAkB,CAAC8C,KAAK,CAChD9C,kBAAkB,CAAC+C,WAAW,CAACC,kBACjC,CAAC;IACD,MAAMC,oBAAoB,GAAG,EAAE;IAC/B,IAAI;MACF,MAAMC,qBAAqB,GAAG,MAAML,mBAAmB;MACvD,IAAI,CAACK,qBAAqB,EAAE;QAC1BD,oBAAoB,CAACE,IAAI,CAACnD,kBAAkB,CAAC+C,WAAW,CAACC,kBAAkB,CAAC;MAC9E;IACF,CAAC,CAAC,MAAM;MACNC,oBAAoB,CAACE,IAAI,CAACnD,kBAAkB,CAAC+C,WAAW,CAACC,kBAAkB,CAAC;IAC9E;IACAhD,kBAAkB,CAACoD,eAAe,CAACH,oBAAoB,CAAC,CAACI,IAAI,CAC3D5B,IAAI,IAAI;MACNrB,QAAQ,CAAC,iBAAiB,EAAEqB,IAAI,CAAC;IACnC,CACF,CAAC;EACH;;EAEA;EACAiB,kBAAkBA,CAAA,EAAG;IACnB,MAAM;MACJY;IACF,CAAC,GAAG,IAAI,CAACd,MAAM;IAEf,IAAI,CAACc,cAAc,EAAE;MACnBlD,QAAQ,CAAC,qDAAqD,CAAC;IACjE;IAEA,IAAIH,QAAQ,CAAC0C,EAAE,KAAK,SAAS,EAAE;MAE7B,IAAIW,cAAc,IAAIA,cAAc,CAACC,oBAAoB,EAAE;QACzDhD,SAAS,CAACiD,YAAY,CAAC;UACrBD,oBAAoB,EAAED,cAAc,CAACC,oBAAoB;UACzDE,yBAAyB,EAAEnD,eAAe,CAACoD,QAAQ,CAAC,CAAC,CAACC,YAAY,CAAC,CAAC,CAACC,6BAA6B;UAClGC,wBAAwB,EAAEvD,eAAe,CAACoD,QAAQ,CAAC,CAAC,CAACC,YAAY,CAAC,CAAC,CAACG;QACtE,CAAC,CAAC;MACJ;IACF;EACF;EAEAC,MAAMA,CAAA,EAAG;IACL3D,QAAQ,CAAC,uCAAuC,CAAC;EACrD;AACJ","ignoreList":[]}